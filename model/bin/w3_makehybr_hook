#!/bin/bash -e
# --------------------------------------------------------------------------- #
# make_HYB    : Script to manage consecutive compiling of parallel and non-   #
#               parallel elements of WAVEWATCH III, using standard compile    #
#               scripts. Hybrid MPI - OpenMP version.                         #
#                                                                             #
#                                                      Hendrik L. Tolman      #
#                                                      April 2014             #
#                                                                             #
#    Copyright 2014 National Weather Service (NWS),                           #
#       National Oceanic and Atmospheric Administration.  All rights          #
#       reserved.  WAVEWATCH III is a trademark of the NWS.                   #
#       No unauthorized use without permission.                               #
#                                                                             #
# --------------------------------------------------------------------------- #

set -e

# --------------------------------------------------------------------------- #
# 1. Preparations                                                             #
# --------------------------------------------------------------------------- #

# 1.a ID header  - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  echo ' '
  echo '                ************************************'
  echo '              ***   WAVEWATCH III compile for HYB  ***'
  echo '                ************************************'
  echo ' '


# 1.c Read data from the environment file  - - - - - - - - - - - - - - - - - -

  source $(dirname $0)/w3_setenv
  main_dir=$WWATCH3_DIR
  temp_dir=$WWATCH3_TMP
  source=$WWATCH3_SOURCE
  list=$WWATCH3_LIST


# 1.d Check / make directories   - - - - - - - - - - - - - - - - - - - - - - -

  # bin dir
  if [ ! -d $main_dir/bin ]
  then
    echo ' '
    echo "[ERROR] Directory $main_dir/bin not found"
    echo '        Please check the content of your directory model'
    exit 1
  fi

  # switch file
  switch_file=$main_dir/bin/switch
  if [ ! -e $switch_file ] || [ ! -r $switch_file ]
  then
    echo ' '
    echo "[ERROR] switch file $switch_file not found"
    echo "        Please run $main_dir/bin/w3_setup <main_dir> -c <comp> -s <switch>"
    exit 1
  fi

  # comp file
  comp_file=$main_dir/bin/comp
  if [ ! -e $comp_file ] || [ ! -r $comp_file ]
  then
    echo ' '
    echo "[ERROR] comp file $comp_file not found"
    echo "        Please run $main_dir/bin/w3_setup <main_dir> -c <comp> -s <switch>"
    exit 1
  fi

  # link file
  link_file=$main_dir/bin/link
  if [ ! -e $link_file ] || [ ! -r $link_file ]
  then
    echo ' '
    echo "[ERROR] link file $comp_file not found"
    echo "        Please run $main_dir/bin/w3_setup <main_dir> -c <comp> -s <switch>"
    exit 1
  fi

# 1.e Check NetCDF setup - - - - - - - - - - - - - - - - - - - - - - - - - - -

  if [ -z "$WWATCH3_NETCDF" ]
  then
    ww3_NetCDF=
  else
    ww3_NetCDF="ww3_prnc ww3_ounf ww3_ounp ww3_bounc ww3_trnc ww3_prtide"
  fi

# --------------------------------------------------------------------------- #
# 2. Process switch files                                                     #
# --------------------------------------------------------------------------- #

  ./sort_switch -e HOOK -r switch
  ./sort_switch -e HOKM -r switch
  ./sort_switch -v -r switch

  cp switch                             switch.hold
  sed -e 's/DIST/SHRD/g' \
      -e 's/OMPG //g'\
      -e 's/OMPX //g'\
      -e 's/OMPH //g'\
      -e 's/MPI //g'                switch.hold > switch.SEQ
  sed 's/SHRD/DIST MPI OMPG OMPH/g' switch.SEQ > switch.HYB

  ./sort_switch -a HOOK -r switch.HYB
  ./sort_switch -a HOKM -r switch.HYB

  if [ -z "$HOOK_INCDIR" ]
  then
     echo "\$HOOK_INCDIR is not set. Please set it before continuing."
     exit 1
  fi

  if [ -z "$HOOK_LIBDIR" ]
  then
     echo "\$HOOK_LIBDIR is not set. Please set it before continuing."
     exit 1
  fi

# --------------------------------------------------------------------------- #
# 3. Compile non-OpenMP codes                                                 #
# --------------------------------------------------------------------------- #
  echo "==> non-OpenMP"
#  rm -rf ../tmp_SEQ
  rm -rf ../tmp ../obj ../mod
  rm -rf ../exe

  cp switch.SEQ switch
# ./w3_make ww3_grid ww3_strt ww3_prep ww3_outf ww3_outp ww3_trck ww3_grib \
#         ww3_uprstr ww3_gspl ww3_gint gx_outf gx_outp ww3_systrk ww3_bound \
#         $ww3_NetCDF
  ./w3_make ww3_grid ww3_outf ww3_outp 

  mv ../exe/exec_type ../exe/exec_type__SEQ
  cp switch.SEQ ../exe/
  mkdir -p ../exe__SEQ
  cp -r ../exe/* ../exe__SEQ/
  mv ../exe__SEQ/link ../exe__SEQ/link.SEQ
  mv ../exe__SEQ/comp ../exe__SEQ/comp.SEQ
  rm -rf ../exe__SEQ/switch
  mkdir -p ../tmp_SEQ
  cp ../tmp/* ../tmp_SEQ/ || true
  rm -r ../tmp

# --------------------------------------------------------------------------- #
# 3. Compile OpenMP codes                                                     #
# --------------------------------------------------------------------------- #
  echo "==> OpenMP"
#  rm -rf ../tmp_HYB
  rm -rf ../tmp ../obj ../mod
  rm -rf ../exe

  cp switch.HYB switch
  if [ $ESMFMKFILE ]
  then
    ./w3_make ww3_shel ww3_multi ww3_multi_esmf ww3_sbs1
  else
#   ./w3_make ww3_shel ww3_multi ww3_sbs1
    ./w3_make ww3_strt ww3_shel 
  fi
  mv ../exe/exec_type ../exe/exec_type__MPI
  cp switch.HYB ../exe/
  mkdir -p ../exe__HYB
  cp -r ../exe/* ../exe__HYB/
  mv ../exe__HYB/link ../exe__HYB/link.HYB
  mv ../exe__HYB/comp ../exe__HYB/comp.HYB
  rm -rf ../exe__HYB/switch
  mkdir -p ../tmp_HYB
  cp ../tmp/* ../tmp_HYB || true
  rm -r ../tmp

# --------------------------------------------------------------------------- #
# 4. Reset switch file                                                        #
# --------------------------------------------------------------------------- #

  cp switch.hold switch

# --------------------------------------------------------------------------- #
# 5. Clean up                                                                 #
# --------------------------------------------------------------------------- #

  rm -f switch.hold switch.SEQ switch.HYB

  mkdir -p ../exe
  cp -r ../exe__*/* ../exe/
  rm -rf ../exearc
  cp -r ../exe ../exearc
  cp ../ff2ww ../exearc/

  echo ' '
  echo ' '
  echo '                   *******************************'
  echo '                 ***       End of program        ***'
  echo '                   *******************************'
  echo ' '

# end of script ------------------------------------------------------------- #
